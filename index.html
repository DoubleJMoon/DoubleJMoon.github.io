<!doctype html>
<html lang="ko">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ëœë¤ ì„ íƒê¸°</title>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <h1>ğŸ° ëœë¤ ì„ íƒê¸°</h1>
      <div class="file-name" id="fileCount">(ì¹´ë“œ ì—†ìŒ)</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label class="file-btn">ğŸ“‚ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        <input id="fileInput" type="file" accept=".txt" multiple>
      </label>
      <button id="addCardBtn">â• ìƒˆ ì¹´ë“œ ì¶”ê°€</button>
      <button id="runAllBtn">ğŸ° ëª¨ë‘ ì¶”ì²¨</button>
      <!-- <button id="rerunAllBtn" class="smallGhost">ğŸ” í•œë²ˆì— ëŒë¦¬ê¸°</button> -->
      <button id="themeToggle" class="smallGhost">ğŸŒ— í…Œë§ˆ</button>
    </div>
  </div>

  <div class="controls" style="margin-top:10px">
    <div style="font-size:13px;color:var(--muted)">â€» ê° ì¹´ë“œì˜ ì œëª©ê³¼ í•­ëª©ì€ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  </div>

  <div id="fileList" class="file-list"></div>

  <div id="allResults">
    <h3>ğŸ“Š ì „ì²´ ìµœì‹  ê²°ê³¼</h3>
    <div id="allResultsContent">ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>

  <div class="footer">
    <div></div>
    <div style="color:var(--muted)">ë§Œë“ ì´: <a href="https://github.com/moondouble" style="text-decoration-line:none;color:var(--muted)" target="_blank">ì •ë§ˆí…Œ</a></div>
  </div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const addCardBtn = document.getElementById('addCardBtn');
const fileList = document.getElementById('fileList');
const runAllBtn = document.getElementById('runAllBtn');
const rerunAllBtn = document.getElementById('rerunAllBtn');
const themeBtn = document.getElementById('themeToggle');
const fileCount = document.getElementById('fileCount');
const allResultsContent = document.getElementById('allResultsContent');

let fileData = [];
let idCounter = 1;
initTheme();
updateFileCount();
updateAllResults();

function updateFileCount(){
  fileCount.textContent = fileData.length ? `${fileData.length} ê°œì˜ ì¹´ë“œ` : '(ì¹´ë“œ ì—†ìŒ)';
}

fileInput.addEventListener('change', async (e) => {
  const files = [...e.target.files];
  for (const f of files) {
    const text = await f.text();
    const items = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const nameWithoutExt = f.name.replace(/\.[^/.]+$/, '');
    const obj = createDataObj(nameWithoutExt, items);
    addCardToDOM(obj, true);
    fileData.push(obj);
  }
  updateAllResults();
  updateFileCount();
});

addCardBtn.addEventListener('click', () => {
  const obj = createDataObj(`ìƒˆ ì¹´ë“œ ${idCounter}`, []);
  addCardToDOM(obj, false);
  fileData.push(obj);
  updateFileCount();
  setTimeout(()=>{ obj.card.querySelector('.cardTitle').focus(); }, 60);
});

function createDataObj(name, items){
  return {id:'card_'+(idCounter++),name,name,items:items.slice(),count:1,result:[],history:[],card:null};
}

function addCardToDOM(obj, fromFile){
  const card = document.createElement('div'); card.className='card';
  card.innerHTML=`
  <div class="titleRow">
    <input class="cardTitle" value="${escapeHtml(obj.name)}" />
    <div style="display:flex;gap:6px;align-items:center">
      <button class="removeBtn smallGhost" title="ì œê±°">ğŸ—‘ï¸</button>
    </div>
  </div>
  <div class="meta">
    <label>ê°œìˆ˜: <input type="number" class="countInput" min="1" value="${obj.count}"></label>
    <div><button class="pickBtn">ì¶”ì²¨</button></div>
  </div>
  <div class="slots" data-slots></div>
  <textarea class="itemsArea" placeholder="í•­ëª©ì„ í•œ ì¤„ì”© ì…ë ¥">${escapeHtml(obj.items.join('\n'))}</textarea>
  <div class="result">â€”</div>
  <div class="history">ê¸°ë¡ ì—†ìŒ</div>
  `;
  obj.card = card;
  fileList.appendChild(card);

  const titleInput = card.querySelector('.cardTitle');
  const removeBtn = card.querySelector('.removeBtn');
  const countInput = card.querySelector('.countInput');
  const pickBtn = card.querySelector('.pickBtn');
  const slotsWrap = card.querySelector('[data-slots]');
  const itemsArea = card.querySelector('.itemsArea');

  titleInput.addEventListener('input', ()=>{ obj.name = titleInput.value; updateAllResults(); });
  removeBtn.addEventListener('click', ()=>{ fileList.removeChild(card); fileData = fileData.filter(x=>x!==obj); updateFileCount(); updateAllResults(); });
  countInput.addEventListener('input', ()=>{ obj.count = parseInt(countInput.value)||1; });
  itemsArea.addEventListener('input', ()=>{ obj.items = itemsArea.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); });
  pickBtn.addEventListener('click', ()=>{ runCard(obj); });
}

function escapeHtml(str){ return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ğŸŒŸ í•µì‹¬: ì ì  ëŠë ¤ì§€ëŠ” ìŠ¬ë¡¯ + ë§ˆì§€ë§‰ì— ê²°ê³¼ í‘œì‹œ */
function runCard(obj){
  const slotsWrap = obj.card.querySelector('[data-slots]');
  slotsWrap.innerHTML = '';
  const selected = [];
  const available = obj.items.slice();
  let i=0;

  function spinNext(){
    if(i>=obj.count || !available.length){
      // ëª¨ë“  ìŠ¬ë¡¯ ì• ë‹ˆë©”ì´ì…˜ ëë‚œ í›„ ê²°ê³¼ í‘œì‹œ
      obj.result = selected;
      obj.history.unshift(selected.join(', '));
      if(obj.history.length>5) obj.history.pop();
      obj.card.querySelector('.result').textContent = selected.join(', ');
      obj.card.querySelector('.history').textContent = obj.history.join('\n');
      updateAllResults();
      return;
    }

    const idx = Math.floor(Math.random()*available.length);
    const val = available.splice(idx,1)[0];
    selected.push(val);

    const slot = document.createElement('div');
    slot.className='slot anim';
    slot.textContent='...';
    slotsWrap.appendChild(slot);

    function spinSlot(step=0, maxSteps=15, delay=30){
      if(step>=maxSteps){
        slot.textContent = val;
        i++;
        spinNext();
        return;
      }
      slot.textContent = available.length ? available[Math.floor(Math.random()*available.length)] : val;
      const nextDelay = delay + step*20;
      setTimeout(()=>spinSlot(step+1, maxSteps, delay), nextDelay);
    }

    spinSlot();
  }

  spinNext();
}

function runAllCardsSequentially(){
  let i=0;
  function next(){
    if(i>=fileData.length) return;
    runCard(fileData[i++]);
    setTimeout(next, 3000);
  }
  next();
}

runAllBtn.addEventListener('click', ()=>runAllCardsSequentially());
<!-- rerunAllBtn.addEventListener('click', ()=>fileData.forEach(runCard)); -->

function updateAllResults(){
  if(!fileData.length){ allResultsContent.textContent = 'ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'; return; }
  allResultsContent.innerHTML = '';
  fileData.forEach(obj=>{
    const div = document.createElement('div');
    div.textContent = `${obj.name}: ${obj.result.length ? obj.result.join(', ') : 'â€”'}`;
    allResultsContent.appendChild(div);
  });
}

/* í…Œë§ˆ í† ê¸€ */
function initTheme(){
  if(localStorage.theme==='light'){ document.body.classList.add('light'); } 
  else { document.body.classList.remove('light'); }
}
themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  localStorage.theme = document.body.classList.contains('light') ? 'light' : 'dark';
});
</script>
</body>
</html>
